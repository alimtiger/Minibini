{% extends 'base.html' %}

{% block title %}Generate Estimate from Worksheet {{ worksheet.est_worksheet_id }} - Minibini{% endblock %}

{% block content %}
<h2>Generate Estimate from Worksheet #{{ worksheet.est_worksheet_id }}</h2>

<div class="worksheet-info">
    <h3>Worksheet Details</h3>
    <table border="1">
        <tr><th>Job</th><td>{{ worksheet.job.job_number }} - {{ worksheet.job.description }}</td></tr>
        <tr><th>Status</th><td><span class="status-{{ worksheet.status }}">{{ worksheet.get_status_display }}</span></td></tr>
        <tr><th>Total Tasks</th><td>{{ tasks.count }}</td></tr>
        <tr><th>Total Cost</th><td>${{ total_cost|floatformat:2 }}</td></tr>
    </table>
</div>

<div class="generation-preview">
    <h3>Estimate Generation Preview</h3>
    <p>The following tasks will be processed according to their mapping strategies:</p>
    
    <table border="1" class="preview-table">
        <thead>
            <tr>
                <th>Task Name</th>
                <th>Mapping Strategy</th>
                <th>Step Type</th>
                <th>Cost</th>
                <th>Will be included?</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr class="task-{% if task.get_mapping_strategy == 'exclude' %}excluded{% else %}included{% endif %}">
                <td>{{ task.name }}</td>
                <td>
                    <span class="mapping-{{ task.get_mapping_strategy }}">
                        {{ task.get_mapping_strategy|default:"direct" }}
                    </span>
                </td>
                <td>{{ task.get_step_type|default:"labor" }}</td>
                <td>
                    {% if task.rate and task.est_qty %}
                        ${% widthratio task.rate|floatformat:2 1 task.est_qty|floatformat:2 %}
                    {% else %}
                        $0.00
                    {% endif %}
                </td>
                <td>
                    {% if task.get_mapping_strategy == 'exclude' %}
                        <span class="excluded">‚ùå Excluded (internal task)</span>
                    {% elif task.get_mapping_strategy == 'direct' %}
                        <span class="included">‚úÖ Direct line item</span>
                    {% elif task.get_mapping_strategy == 'bundle_to_product' %}
                        <span class="included">‚úÖ Bundled into product</span>
                    {% elif task.get_mapping_strategy == 'bundle_to_service' %}
                        <span class="included">‚úÖ Bundled into service</span>
                    {% else %}
                        <span class="included">‚úÖ Direct line item (default)</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="generation-actions">
    <h3>Generate Estimate</h3>
    <p>Click the button below to generate a new estimate from this worksheet. This will:</p>
    <ul>
        <li>Create a new estimate linked to job "{{ worksheet.job.job_number }}"</li>
        <li>Process all tasks according to their mapping strategies</li>
        <li>Bundle related tasks into products/services where specified</li>
        <li>Exclude internal tasks from the customer-facing estimate</li>
        <li>Apply pricing rules and calculate totals</li>
    </ul>
    
    <form method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary btn-large">
            üßæ Generate Estimate Now
        </button>
        <a href="{% url 'jobs:estworksheet_detail' worksheet.est_worksheet_id %}" class="btn btn-secondary">
            Cancel
        </a>
    </form>
</div>

<style>
.worksheet-info {
    margin-bottom: 30px;
}

.worksheet-info table {
    max-width: 600px;
}

.worksheet-info th {
    background-color: #f5f5f5;
    text-align: left;
    padding: 8px;
    width: 150px;
}

.worksheet-info td {
    padding: 8px;
}

.generation-preview {
    margin-bottom: 30px;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
}

.preview-table th, .preview-table td {
    padding: 8px;
    text-align: left;
    border: 1px solid #ddd;
}

.preview-table th {
    background-color: #f5f5f5;
    font-weight: bold;
}

.task-excluded {
    background-color: #fff5f5;
    opacity: 0.7;
}

.task-included {
    background-color: #f5fff5;
}

.generation-actions {
    border: 2px solid #007bff;
    padding: 20px;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.generation-actions ul {
    margin: 15px 0;
    padding-left: 25px;
}

.btn {
    display: inline-block;
    padding: 8px 16px;
    margin-right: 10px;
    text-decoration: none;
    border-radius: 4px;
    border: 1px solid;
    cursor: pointer;
    font-size: 14px;
}

.btn-large {
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
}

.btn-primary {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

.btn:hover {
    opacity: 0.8;
}

.status-draft { color: #f39c12; font-weight: bold; }
.status-final { color: #27ae60; font-weight: bold; }
.status-superseded { color: #7f8c8d; }

.mapping-direct { color: #17a2b8; font-weight: bold; }
.mapping-bundle_to_product { color: #28a745; font-weight: bold; }
.mapping-bundle_to_service { color: #fd7e14; font-weight: bold; }
.mapping-exclude { color: #dc3545; font-weight: bold; }

.included { color: #28a745; font-weight: bold; }
.excluded { color: #dc3545; font-weight: bold; }
</style>
{% endblock %}