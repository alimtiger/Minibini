{% extends 'base.html' %}

{% block title %}Worksheet {{ worksheet.est_worksheet_id }} - Minibini{% endblock %}

{% block content %}
<h2{% if worksheet.status == 'superseded' %} class="superseded"{% endif %}>Estimate Worksheet #{{ worksheet.est_worksheet_id }}</h2>

<table border="1"{% if worksheet.status == 'superseded' %} class="superseded"{% endif %}>
    <tr><th>Job</th><td><a href="{% url 'jobs:detail' worksheet.job.job_id %}">{{ worksheet.job.job_number }}{% if worksheet.job.name %}: {{ worksheet.job.name }}{% endif %}</a></td></tr>
    <tr><th>Status</th><td>{{ worksheet.get_status_display }}</td></tr>
    <tr><th>Version</th><td>{{ worksheet.version }}</td></tr>
    <tr><th>Created</th><td>{{ worksheet.created_date }}</td></tr>
    {% if worksheet.estimate %}
    <tr><th>Linked Estimate</th><td><a href="{% url 'jobs:estimate_detail' worksheet.estimate.estimate_id %}">{{ worksheet.estimate.estimate_number }}</a></td></tr>
    {% endif %}
    <tr><th>Total Cost</th><td>${{ total_cost|floatformat:2 }}</td></tr>
</table>

{% if worksheet.parent %}
<p>
    <strong>Parent Worksheet:</strong> <a href="{% url 'jobs:estworksheet_detail' worksheet.parent.est_worksheet_id %}">Worksheet (v{{ worksheet.parent.version }})</a>
</p>
{% endif %}

{% if worksheet.children.exists %}
<p>
    <strong>Child Worksheets:</strong>
    {% for child in worksheet.children.all %}
        <a href="{% url 'jobs:estworksheet_detail' child.est_worksheet_id %}">Worksheet (v{{ child.version }})</a>{% if not forloop.last %}, {% endif %}
    {% endfor %}
</p>
{% endif %}

<p>
    {% if worksheet.status == 'draft' %}
        <a href="{% url 'jobs:estworksheet_generate_estimate' worksheet.est_worksheet_id %}">Generate Estimate</a> |
    {% else %}
        <form method="post" action="{% url 'jobs:estworksheet_revise' worksheet.est_worksheet_id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit">Revise Worksheet</button>
        </form> |
    {% endif %}
    {% if worksheet.estimate %}
        <a href="{% url 'jobs:estimate_detail' worksheet.estimate.estimate_id %}">View Estimate</a> |
    {% endif %}
    <a href="{% url 'jobs:estworksheet_list' %}">Back to Worksheets</a>
</p>

<h3>Tasks</h3>

{% if worksheet.status == 'draft' %}
<p>
    <a href="{% url 'jobs:task_add_from_template' worksheet.est_worksheet_id %}">Add Task from Template</a> |
    <a href="{% url 'jobs:task_add_manual' worksheet.est_worksheet_id %}">Add Task Manually</a>
</p>
{% else %}
<p style="color: #666; font-style: italic;">
    Tasks cannot be added to a {{ worksheet.get_status_display|lower }} worksheet.
</p>
{% endif %}

{% if tasks %}
    <table border="1">
        <tr>
            <th>Est. Qty</th>
            <th>Units</th>
            <th>Task Name</th>
            <th>Template</th>
            <th>Rate</th>
            <th>Total</th>
        </tr>
        {% for task in tasks %}
        <tr>
            <td>{{ task.est_qty|floatformat:2 }}</td>
            <td>{{ task.units }}</td>
            <td><a href="{% url 'jobs:task_detail' task.task_id %}">{{ task.name }}</a></td>
            <td>
                {% if task.template %}
                    {{ task.template.template_name }}
                {% else %}
                    No template
                {% endif %}
            </td>
            <td>${{ task.rate|floatformat:2 }}</td>
            <td>${{ task.calculated_total|floatformat:2 }}</td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="5"><strong>Total:</strong></td>
            <td><strong>${{ total_cost|floatformat:2 }}</strong></td>
        </tr>
    </table>
{% else %}
    <p>No tasks found in this worksheet.</p>
{% endif %}

{% endblock %}