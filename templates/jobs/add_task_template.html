{% extends 'base.html' %}

{% block title %}Add Task Template - Minibini{% endblock %}

{% block navigation %}
<strong>Settings:</strong>
<a href="{% url 'jobs:work_order_template_list' %}">Templates</a> |
<a href="{% url 'jobs:add_work_order_template' %}">Add Template</a> |
<a href="{% url 'jobs:task_mapping_list' %}">Task Mappings</a> |
<a href="{% url 'core:user_list' %}">Users</a>
{% endblock %}

{% block content %}
<h2>Add Task Template to "{{ work_order_template.template_name }}"</h2>

{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}

<form method="post">
    {% csrf_token %}
    <table>
        {{ form.as_table }}
    </table>
    <br>
    <button type="submit" name="add">Add Task Template</button>
    <button type="submit" name="add_another">Add and Create Another</button>
    <a href="{% url 'jobs:work_order_template_detail' work_order_template.template_id %}">Cancel</a>
</form>

{% if existing_tasks %}
<h3>Existing Task Templates for This Work Order Template</h3>
<table border="1">
    <tr>
        <th>Template ID</th>
        <th>Template Name</th>
        <th>Description</th>
        <th>Units</th>
        <th>Rate</th>
        <th>Est. Quantity</th>
        <th>Task Mapping</th>
        <th>Parent Template</th>
        <th>Created Date</th>
        <th>Active</th>
    </tr>
    {% for task in existing_tasks %}
    <tr>
        <td>{{ task.template_id }}</td>
        <td>{{ task.template_name }}</td>
        <td>{{ task.description|truncatewords:10|default:"-" }}</td>
        <td>{{ task.units|default:"-" }}</td>
        <td>
            {% if task.rate %}
                ${{ task.rate|floatformat:2 }}
            {% else %}
                -
            {% endif %}
        </td>
        <td>{{ task.est_qty|floatformat:2|default:"-" }}</td>
        <td>
            {% if task.task_mapping %}
                {{ task.task_mapping.mapping_strategy }} ({{ task.task_mapping.step_type }})
            {% else %}
                -
            {% endif %}
        </td>
        <td>
            {% if task.parent_template %}
                {{ task.parent_template.template_name }}
            {% else %}
                -
            {% endif %}
        </td>
        <td>{{ task.created_date|date:"M d, Y" }}</td>
        <td>{{ task.is_active|yesno:"Yes,No" }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>No task templates have been added to this work order template yet.</p>
{% endif %}

{% endblock %}