{% extends 'base.html' %}

{% block title %}Estimate {{ estimate.estimate_number }} - Minibini{% endblock %}

{% block content %}
<h2{% if estimate.status == 'superseded' %} class="superseded"{% endif %}>Estimate: {{ estimate.estimate_number }}</h2>

<table border="1"{% if estimate.status == 'superseded' %} class="superseded"{% endif %}>
    <tr>
        <th>Field</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>Estimate Number</td>
        <td>{{ estimate.estimate_number }}</td>
    </tr>
    <tr>
        <td>Job</td>
        <td><a href="{% url 'jobs:detail' estimate.job.pk %}">{{ estimate.job }}</a></td>
    </tr>
    <tr>
        <td>Version</td>
        <td>{{ estimate.version }}</td>
    </tr>
    <tr>
        <td>Status</td>
        <td>
            {{ estimate.get_status_display }}
            {% if status_form %}
                <form method="post" style="display: inline; margin-left: 20px;">
                    {% csrf_token %}
                    {{ status_form.status }}
                    <button type="submit" name="update_status">Update Status</button>
                </form>
            {% endif %}
        </td>
    </tr>
    <tr>
        <td>Created Date</td>
        <td>{{ estimate.created_date|date:"Y-m-d H:i" }}</td>
    </tr>
    <tr>
        <td>Sent Date</td>
        <td>{{ estimate.sent_date|date:"Y-m-d H:i"|default:"Not sent yet" }}</td>
    </tr>
    <tr>
        <td>Expiration Date</td>
        <td>{{ estimate.expiration_date|date:"Y-m-d H:i"|default:"Not set" }}</td>
    </tr>
    <tr>
        <td>Closed Date</td>
        <td>{{ estimate.closed_date|date:"Y-m-d H:i"|default:"Not closed yet" }}</td>
    </tr>
</table>

{% if estimate.parent %}
<p>
    <strong>Parent Estimate:</strong> <a href="{% url 'jobs:estimate_detail' estimate.parent.estimate_id %}">{{ estimate.parent.estimate_number }} (v{{ estimate.parent.version }})</a>
</p>
{% endif %}

{% if estimate.children.exists %}
<p>
    <strong>Child Estimates:</strong>
    {% for child in estimate.children.all %}
        <a href="{% url 'jobs:estimate_detail' child.estimate_id %}">{{ child.estimate_number }} (v{{ child.version }})</a>{% if not forloop.last %}, {% endif %}
    {% endfor %}
</p>
{% endif %}

{% if estimate.status != 'superseded' %}
    <p>
        {% if estimate.status == 'draft' %}
            <a href="{% url 'jobs:estimate_add_line_item' estimate.estimate_id %}">Add Line Item</a>
        {% endif %}
        {% if estimate.status != 'draft' %}
            <a href="{% url 'jobs:estimate_revise' estimate.estimate_id %}">Revise Estimate</a>
        {% endif %}
        {% if estimate.status == 'accepted' %}
            {% if estimate.status != 'draft' %} | {% endif %}
            <a href="{% url 'jobs:work_order_create_from_estimate' estimate.estimate_id %}">Create Work Order</a>
        {% endif %}
    </p>
{% else %}
    <p>
        <span style="color: #666; font-style: italic;">This estimate has been superseded and cannot be modified.</span>
    </p>
{% endif %}

<h3>Line Items</h3>
{% if line_items %}
    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr>
                <th>Line #</th>
                <th>Description</th>
                <th>Task/Price List Item</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total</th>
                {% if estimate.status == 'draft' %}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in line_items %}
            <tr>
                <td>{{ item.line_number|default:item.line_number }}</td>
                <td>{{ item.description|default:"No description" }}</td>
                <td>
                    {% if item.task %}
                        Task: {{ item.task.name }}
                    {% elif item.price_list_item %}
                        {{ item.price_list_item.code }} - {{ item.price_list_item.description|truncatewords:5 }}
                    {% else %}
                        No source
                    {% endif %}
                </td>
                <td>{{ item.qty }}</td>
                <td>{{ item.unit_parts_labor|default:"â€”" }}</td>
                <td>${{ item.price_currency|floatformat:2 }}</td>
                <td>${{ item.total_amount|floatformat:2 }}</td>
                {% if estimate.status == 'draft' %}
                <td>
                    <form method="post" action="{% url 'jobs:estimate_delete_line_item' estimate.estimate_id item.line_item_id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('Are you sure you want to delete this line item?');">Delete</button>
                    </form>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td colspan="{% if estimate.status == 'draft' %}7{% else %}6{% endif %}">Total Estimate Amount:</td>
                <td>${{ total_amount|floatformat:2 }}</td>
            </tr>
        </tfoot>
    </table>
{% else %}
    <p>No line items found for this estimate.</p>
{% endif %}

<p>
    {% if worksheet %}
        <a href="{% url 'jobs:estworksheet_detail' worksheet.est_worksheet_id %}">View Source Worksheet</a> |
    {% endif %}
    <a href="{% url 'jobs:detail' estimate.job.pk %}">View Job Details</a> |
    <a href="{% url 'jobs:estimate_list' %}">Back to Estimates List</a>
</p>
{% endblock %}
