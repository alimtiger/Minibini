{% extends 'base.html' %}

{% block title %}Estimate {{ estimate.estimate_number }} - Minibini{% endblock %}

{% block content %}
<h2{% if estimate.status == 'superseded' %} class="superseded"{% endif %}>Estimate: {{ estimate.estimate_number }}</h2>

<table border="1"{% if estimate.status == 'superseded' %} class="superseded"{% endif %}>
    <tr>
        <th>Field</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>Estimate ID</td>
        <td>{{ estimate.estimate_id }}</td>
    </tr>
    <tr>
        <td>Estimate Number</td>
        <td>{{ estimate.estimate_number }}</td>
    </tr>
    <tr>
        <td>Job</td>
        <td><a href="{% url 'jobs:detail' estimate.job.pk %}">{{ estimate.job }}</a></td>
    </tr>
    <tr>
        <td>Version</td>
        <td>{{ estimate.version }}</td>
    </tr>
    <tr>
        <td>Status</td>
        <td>{{ estimate.get_status_display }}</td>
    </tr>
</table>

{% if estimate.parent %}
<p>
    <strong>Parent Estimate:</strong> <a href="{% url 'jobs:estimate_detail' estimate.parent.estimate_id %}">{{ estimate.parent.estimate_number }} (v{{ estimate.parent.version }})</a>
</p>
{% endif %}

{% if estimate.children.exists %}
<p>
    <strong>Child Estimates:</strong>
    {% for child in estimate.children.all %}
        <a href="{% url 'jobs:estimate_detail' child.estimate_id %}">{{ child.estimate_number }} (v{{ child.version }})</a>{% if not forloop.last %}, {% endif %}
    {% endfor %}
</p>
{% endif %}

<p>
    {% if estimate.status != 'superseded' %}
        <a href="{% url 'jobs:estimate_add_line_item' estimate.estimate_id %}">Add Line Item</a> |
        <a href="{% url 'jobs:estimate_update_status' estimate.estimate_id %}">Update Status</a>
        {% if estimate.status == 'draft' %}
            | <form method="post" action="{% url 'jobs:estimate_mark_open' estimate.estimate_id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit">Mark as Open</button>
            </form>
        {% else %}
            | <a href="{% url 'jobs:estimate_revise' estimate.estimate_id %}">Revise Estimate</a>
        {% endif %}
    {% else %}
        <span style="color: #666; font-style: italic;">This estimate has been superseded and cannot be modified.</span>
    {% endif %}
</p>

<h3>Line Items</h3>
{% if line_items %}
    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr>
                <th>Line #</th>
                <th>Description</th>
                <th>Task/Price List Item</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in line_items %}
            <tr>
                <td>{{ item.line_number|default:item.line_number }}</td>
                <td>{{ item.description|default:"No description" }}</td>
                <td>
                    {% if item.task %}
                        Task: {{ item.task.name }}
                    {% elif item.price_list_item %}
                        {{ item.price_list_item.code }} - {{ item.price_list_item.description|truncatewords:5 }}
                    {% else %}
                        No source
                    {% endif %}
                </td>
                <td>{{ item.qty }}</td>
                <td>{{ item.unit_parts_labor|default:"â€”" }}</td>
                <td>${{ item.price_currency|floatformat:2 }}</td>
                <td>${{ item.total_amount|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td colspan="6">Total Estimate Amount:</td>
                <td>${{ total_amount|floatformat:2 }}</td>
            </tr>
        </tfoot>
    </table>
{% else %}
    <p>No line items found for this estimate.</p>
{% endif %}

<p>
    {% if worksheet %}
        <a href="{% url 'jobs:estworksheet_detail' worksheet.est_worksheet_id %}">View Source Worksheet</a> |
    {% endif %}
    <a href="{% url 'jobs:detail' estimate.job.pk %}">View Job Details</a> |
    <a href="{% url 'jobs:estimate_list' %}">Back to Estimates List</a>
</p>
{% endblock %}
