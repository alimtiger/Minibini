{% extends 'base.html' %}

{% block title %}Job {{ job.job_number }} - Minibini{% endblock %}

{% block content %}
<h2>Job {{ job.job_number }}</h2>

<p>
    <a href="{% url 'jobs:edit' job.job_id %}">Edit Job</a>
</p>

<table border="1">
    <tr>
        <th>Field</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>Job Number</td>
        <td>{{ job.job_number }}</td>
    </tr>
    <tr>
        <td>Job Name</td>
        <td>{{ job.name }}</td>
    </tr>
    <tr>
        <td>Status</td>
        <td>{{ job.get_status_display }}</td>
    </tr>
    <tr>
        <td>Created Date</td>
        <td>{{ job.created_date|date:"Y-m-d H:i" }}</td>
    </tr>
    <tr>
        <td>Start Date</td>
        <td>{{ job.start_date|date:"Y-m-d H:i"|default:"Not started yet" }}</td>
    </tr>
    <tr>
        <td>Due Date</td>
        <td>{{ job.due_date|date:"Y-m-d H:i"|default:"No due date set" }}</td>
    </tr>
    <tr>
        <td>Completed Date</td>
        <td>{{ job.completed_date|date:"Y-m-d H:i"|default:"Not completed yet" }}</td>
    </tr>
    <tr>
        <td>Contact</td>
        <td>
            {% if job.contact %}
                <a href="{% url 'contacts:contact_detail' job.contact.contact_id %}">{{ job.contact.name }}</a>
            {% else %}
                No contact
            {% endif %}
        </td>
    </tr>
    <tr>
        <td>Description</td>
        <td>{{ job.description|default:"No description" }}</td>
    </tr>
</table>

<h3>Estimate Worksheets</h3>
{% if job.status == 'draft' %}
<p>
    <a href="{% url 'jobs:estworksheet_create_for_job' job.job_id %}">Create New Worksheet</a>
</p>
{% endif %}
{% if worksheets %}
    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr>
                <th>Status</th>
                <th>Version</th>
                <th>Created Date</th>
                <th>Linked Estimate</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for worksheet in worksheets %}
            <tr>
                <td>{{ worksheet.get_status_display }}</td>
                <td>{{ worksheet.version }}</td>
                <td>{{ worksheet.created_date|date:"M d, Y" }}</td>
                <td>
                    {% if worksheet.estimate %}
                        <a href="{% url 'jobs:estimate_detail' worksheet.estimate.estimate_id %}">{{ worksheet.estimate.estimate_number }}</a>
                    {% else %}
                        <em>Not generated</em>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'jobs:estworksheet_detail' worksheet.est_worksheet_id %}">View Details</a>
                    {% if worksheet.status == 'draft' %}
                        | <a href="{% url 'jobs:estworksheet_generate_estimate' worksheet.est_worksheet_id %}">Generate Estimate</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No estimate worksheets found for this job.</p>
{% endif %}


{% if not current_estimate %}
<p>
    <a href="{% url 'jobs:estimate_create_for_job' job.job_id %}">Create New Estimate</a>
</p>
<p>No current estimate found for this job.</p>
{% else %}
<h3>Current Estimate <a href="{% url 'jobs:estimate_detail' current_estimate.pk %}">{{ current_estimate.estimate_number }} v{{ current_estimate.version }}</a> -
    {{current_estimate.get_status_display }}</h3>
    <p>Created {{ current_estimate.created_date|date:"Y-m-d H:i" }},
       Sent: {{ current_estimate.sent_date|date:"Y-m-d H:i"|default:"Not sent yet" }},
       Expiration: {{ current_estimate.expiration_date|date:"Y-m-d H:i"|default:"Not set" }},
       {{current_estimate.get_status_display }}: {{ current_estimate.closed_date|date:"Y-m-d H:i"|default:"Not closed yet" }}
    </p>

    {% if current_estimate_line_items %}
        <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
            <thead>
                <tr>
                    <th>Line #</th>
                    <th>Description</th>
                    <th>Task/Price List Item</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in current_estimate_line_items %}
                <tr>
                    <td>{{ item.line_number|default:item.line_number }}</td>
                    <td>{{ item.description|default:"No description" }}</td>
                    <td>
                        {% if item.task %}
                            Task: {{ item.task.name }}
                        {% elif item.price_list_item %}
                            {{ item.price_list_item.code }} - {{ item.price_list_item.description|truncatewords:5 }}
                        {% else %}
                            No source
                        {% endif %}
                    </td>
                    <td>{{ item.qty }}</td>
                    <td>{{ item.unit_parts_labor|default:"—" }}</td>
                    <td>${{ item.price_currency|floatformat:2 }}</td>
                    <td>${{ item.total_amount|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background-color: #f0f0f0; font-weight: bold;">
                    <td colspan="6">Total Estimate Amount:</td>
                    <td>${{ current_estimate_total|floatformat:2 }}</td>
                </tr>
            </tfoot>
        </table>
    {% else %}
        <p>No line items found for this estimate.</p>
    {% endif %}

    <p style="margin-top: 10px;">
        {% if current_estimate.status == 'draft' %}
            <a href="{% url 'jobs:estimate_add_line_item' current_estimate.estimate_id %}">Add Line Item</a>
        {% endif %}
        {% if current_estimate.status != 'draft' %}
            <a href="{% url 'jobs:estimate_revise' current_estimate.estimate_id %}">Revise Estimate</a>
        {% endif %}
        {% if current_estimate.status == 'accepted' %}
            {% if current_estimate.status != 'draft' %} | {% endif %}
            <a href="{% url 'jobs:work_order_create_from_estimate' current_estimate.estimate_id %}">Create Work Order</a>
        {% endif %}
    </p>
{% endif %}

<h3>Superseded Estimates</h3>
{% if superseded_estimates %}
    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr>
                <th>Estimate Number</th>
                <th>Status</th>
                <th>Created</th>
                <th>Sent</th>
                <th>Expiration</th>
                <th>Closed</th>
            </tr>
        </thead>
        <tbody>
            {% for estimate in superseded_estimates %}
            <tr>
                <td><a href="{% url 'jobs:estimate_detail' estimate.pk %}">{{ estimate.estimate_number }} v{{ estimate.version }}</a></td>
                <td>{{ estimate.get_status_display }}</td>
                <td>{{ estimate.created_date|date:"M d, Y" }}</td>
                <td>{{ estimate.sent_date|date:"M d, Y"|default:"—" }}</td>
                <td>{{ estimate.expiration_date|date:"M d, Y"|default:"—" }}</td>
                <td>{{ estimate.closed_date|date:"M d, Y"|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No superseded estimates.</p>
{% endif %}

<h3>Associated Work Orders</h3>
{% if work_orders %}
    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr>
                <th>Status</th>
                <th>Template</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for work_order in work_orders %}
            <tr>
                <td>{{ work_order.get_status_display }}</td>
                <td>{{ work_order.template.template_name|default:"—" }}</td>
                <td>
                    <a href="{% url 'jobs:work_order_detail' work_order.work_order_id %}">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No work orders found for this job.</p>
{% endif %}

<h3>Associated Purchase Orders</h3>
{% if purchase_orders %}
    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr>
                <th>PO Number</th>
                <th>Price List Item</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase_order in purchase_orders %}
            <tr>
                <td>{{ purchase_order.po_number }}</td>
                <td>{{ purchase_order.price_list_item|default:"—" }}</td>
                <td>
                    <a href="{% url 'purchasing:purchase_order_detail' purchase_order.po_id %}">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No purchase orders found for this job.</p>
{% endif %}

<h3>Associated Invoices</h3>
{% if invoices %}
    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr>
                <th>Invoice Number</th>
                <th>Customer PO Number</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in invoices %}
            <tr>
                <td>{{ invoice.invoice_number }}</td>
                <td>{{ invoice.customer_po_number|default:"No PO Number" }}</td>
                <td>{{ invoice.get_status_display }}</td>
                <td>
                    <a href="{% url 'invoicing:invoice_detail' invoice.pk %}">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No invoices found for this job.</p>
{% endif %}

<p><a href="{% url 'jobs:list' %}">Back to Jobs List</a></p>
{% endblock %}