{% extends 'base.html' %}

{% block title %}Create Work Order from Estimate - Minibini{% endblock %}

{% block content %}
<h2>Create Work Order from Estimate</h2>

<p>You are about to create a Work Order from the following estimate:</p>

<table border="1">
    <tr>
        <th>Estimate Number</th>
        <td>{{ estimate.estimate_number }}</td>
    </tr>
    <tr>
        <th>Job</th>
        <td>{{ estimate.job.job_number }}{% if estimate.job.name %}: {{ estimate.job.name }}{% endif %}</td>
    </tr>
    <tr>
        <th>Estimate Status</th>
        <td>{{ estimate.get_status_display }}</td>
    </tr>
    <tr>
        <th>Version</th>
        <td>{{ estimate.version }}</td>
    </tr>
</table>

<h3>Line Items Analysis</h3>
<p>The Work Order will be created from {{ total_line_items }} line item{{ total_line_items|pluralize }}:</p>

{% if worksheet_items %}
<h4>From Worksheet Tasks ({{ worksheet_items|length }})</h4>
<ul>
    {% for item in worksheet_items %}
    <li>{{ item.description|default:item.task.name }} - ${{ item.price }} (Qty: {{ item.qty }})</li>
    {% endfor %}
</ul>
<p><em>These will copy existing task details and hierarchy.</em></p>
{% endif %}

{% if catalog_items %}
<h4>From Catalog Items ({{ catalog_items|length }})</h4>
<ul>
    {% for item in catalog_items %}
    <li>{{ item.price_list_item.code }}: {{ item.description|default:item.price_list_item.description }} - ${{ item.price }} (Qty: {{ item.qty }})</li>
    {% endfor %}
</ul>
<p><em>These will create new tasks based on catalog item details.</em></p>
{% endif %}

{% if manual_items %}
<h4>Manual Line Items ({{ manual_items|length }})</h4>
<ul>
    {% for item in manual_items %}
    <li>{% if item.description %}{{ item.description }}{% else %}Line item #{{ item.line_number|default:item.pk }}{% endif %} - ${{ item.price }} (Qty: {{ item.qty }})</li>
    {% endfor %}
</ul>
<p><em>These will create generic tasks that may need manual refinement.</em></p>
{% endif %}

<h3>Work Order Details</h3>
<p>The new Work Order will be created with:</p>
<ul>
    <li>Status: Draft</li>
    <li>Job: {{ estimate.job.job_number }}{% if estimate.job.name %}: {{ estimate.job.name }}{% endif %}</li>
    <li>Tasks generated from all line items above</li>
    {% if worksheet %}
    <li>Template: {{ worksheet.template.template_name|default:"No template" }}</li>
    {% endif %}
</ul>

<form method="post" style="margin-top: 20px;">
    {% csrf_token %}
    <button type="submit" class="btn-primary">Create Work Order</button>
    <a href="{% url 'jobs:estimate_detail' estimate.estimate_id %}" class="btn-secondary">Cancel</a>
</form>

{% endblock %}