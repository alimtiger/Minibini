{% extends 'base.html' %}

{% block title %}Email - Minibini{% endblock %}

{% block content %}
<h2>Email Details</h2>

<p>
    <a href="{% url 'core:email_inbox' %}">&larr; Back to Inbox</a>
    {% if not email_record.job %}
        | <strong><a href="{% url 'core:create_job_from_email' email_record.email_record_id %}">Create Job from this Email</a></strong>
    {% endif %}
</p>

{% if email_content %}
    <table border="1">
        <tr>
            <th>From:</th>
            <td>{{ email_content.from }}</td>
        </tr>
        <tr>
            <th>To:</th>
            <td>{{ email_content.to|join:", " }}</td>
        </tr>
        {% if email_content.cc %}
        <tr>
            <th>CC:</th>
            <td>{{ email_content.cc|join:", " }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Date:</th>
            <td>{{ email_content.date|date:"Y-m-d H:i:s" }}</td>
        </tr>
        <tr>
            <th>Subject:</th>
            <td><strong>{{ email_content.subject }}</strong></td>
        </tr>
        <tr>
            <th>Job:</th>
            <td>
                {% if email_record.job %}
                    <a href="{% url 'jobs:detail' email_record.job.job_id %}">{{ email_record.job.job_number }}</a> - {{ email_record.job.description|truncatewords:10 }}
                {% else %}
                    <em>Not linked to any job</em>
                {% endif %}
            </td>
        </tr>
    </table>

    <h3>Message Body</h3>
    {% if email_content.html %}
        <div style="border: 1px solid; padding: 10px;">
            {{ email_content.html|safe }}
        </div>
    {% elif email_content.text %}
        <pre style="border: 1px solid; padding: 10px; white-space: pre-wrap;">{{ email_content.text }}</pre>
    {% else %}
        <p><em>No message body available</em></p>
    {% endif %}

    {% if email_content.attachments %}
        <h3>Attachments ({{ email_content.attachments|length }})</h3>
        <ul>
            {% for attachment in email_content.attachments %}
                <li>
                    <strong>{{ attachment.filename }}</strong>
                    ({{ attachment.content_type }}, {{ attachment.size }} bytes)
                </li>
            {% endfor %}
        </ul>
    {% endif %}

{% elif temp_data %}
    <p><strong>Email metadata available, but full content could not be retrieved from server.</strong></p>
    <table border="1">
        <tr>
            <th>From:</th>
            <td>{{ temp_data.from_email }}</td>
        </tr>
        <tr>
            <th>To:</th>
            <td>{{ temp_data.to_email }}</td>
        </tr>
        {% if temp_data.cc_email %}
        <tr>
            <th>CC:</th>
            <td>{{ temp_data.cc_email }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Date:</th>
            <td>{{ temp_data.date_sent|date:"Y-m-d H:i:s" }}</td>
        </tr>
        <tr>
            <th>Subject:</th>
            <td><strong>{{ temp_data.subject }}</strong></td>
        </tr>
    </table>
{% else %}
    <p><strong>Email not found or could not be retrieved from server.</strong></p>
    <p>Message ID: {{ email_record.message_id }}</p>
{% endif %}

{% endblock %}
