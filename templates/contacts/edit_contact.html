{% extends 'base.html' %}

{% block title %}Edit Contact - Minibini{% endblock %}

{% block content %}
<h2>Edit Contact: {{ contact.name }}</h2>

{% if messages %}
    {% for message in messages %}
        <div style="padding: 10px; margin-bottom: 10px; background-color: {% if message.tags == 'error' %}#ffebee; color: #c62828;{% else %}#e8f5e8; color: #2e7d32;{% endif %}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" style="max-width: 400px;">
    {% csrf_token %}
    <div style="margin-bottom: 15px;">
        <label for="name" style="display: block; margin-bottom: 5px; font-weight: bold;">Name *</label>
        <input type="text" id="name" name="name" value="{{ contact.name }}" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 15px;">
        <label for="email" style="display: block; margin-bottom: 5px; font-weight: bold;">Email Address</label>
        <input type="email" id="email" name="email" value="{{ contact.email }}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 15px;">
        <label for="work_number" style="display: block; margin-bottom: 5px; font-weight: bold;">Work Phone</label>
        <input type="tel" id="work_number" name="work_number" value="{{ contact.work_number }}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 15px;">
        <label for="mobile_number" style="display: block; margin-bottom: 5px; font-weight: bold;">Mobile Phone</label>
        <input type="tel" id="mobile_number" name="mobile_number" value="{{ contact.mobile_number }}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 15px;">
        <label for="home_number" style="display: block; margin-bottom: 5px; font-weight: bold;">Home Phone</label>
        <input type="tel" id="home_number" name="home_number" value="{{ contact.home_number }}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 15px;">
        <label for="address" style="display: block; margin-bottom: 5px; font-weight: bold;">Street Address</label>
        <input type="text" id="address" name="address" value="{{ contact.addr1 }}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 15px;">
        <label for="city" style="display: block; margin-bottom: 5px; font-weight: bold;">City</label>
        <input type="text" id="city" name="city" value="{{ contact.city }}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div style="margin-bottom: 20px;">
        <label for="postal_code" style="display: block; margin-bottom: 5px; font-weight: bold;">Postal Code</label>
        <input type="text" id="postal_code" name="postal_code" value="{{ contact.postal_code }}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <!-- Business Information Section -->
    <fieldset style="border: 2px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
        <legend style="font-weight: bold; font-size: 16px; padding: 0 10px;">Business Association</legend>

        {% if contact.business %}
        <p style="margin-bottom: 15px; font-style: italic; color: #666;">Currently associated with: <strong>{{ contact.business.business_name }}</strong></p>
        {% else %}
        <p style="margin-bottom: 15px; font-style: italic; color: #666;">Not currently associated with a business.</p>
        {% endif %}

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Business Association Options:</label>

            <div style="margin-bottom: 10px;">
                <input type="radio" id="no_business" name="business_selection_mode" value="none" {% if not contact.business %}checked{% endif %} style="margin-right: 8px;">
                <label for="no_business">No business association</label>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="radio" id="existing_business" name="business_selection_mode" value="existing" style="margin-right: 8px;">
                <label for="existing_business">Associate with existing business</label>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="radio" id="search_business" name="business_selection_mode" value="name_search" style="margin-right: 8px;">
                <label for="search_business">Search by business name</label>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="radio" id="new_business" name="business_selection_mode" value="new" style="margin-right: 8px;">
                <label for="new_business">Create new business</label>
            </div>
        </div>

        <!-- Existing Business Dropdown -->
        <div id="existing_business_section" style="display: none; margin-bottom: 20px;">
            <label for="existing_business_id" style="display: block; margin-bottom: 5px; font-weight: bold;">Select Existing Business:</label>
            <select id="existing_business_id" name="existing_business_id" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="">-- Select a Business --</option>
                {% for business in existing_businesses %}
                <option value="{{ business.business_id }}"
                    data-business-name="{{ business.business_name }}"
                    data-reference-code="{{ business.our_reference_code }}"
                    data-business-number="{{ business.business_number }}"
                    data-business-address="{{ business.business_address }}"
                    data-tax-exemption="{{ business.tax_exemption_number }}"
                    data-tax-cloud="{{ business.tax_cloud }}">
                    {{ business.business_name }}
                </option>
                {% endfor %}
            </select>

            <!-- Business Info Display -->
            <div id="selected_business_info" style="display: none; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                <h4 style="margin: 0 0 10px 0; color: #495057;">Selected Business Information (Read Only)</h4>
                <div id="business_info_content"></div>
                <small style="color: #6c757d; margin-top: 10px; display: block;"><em>Business information cannot be modified when selecting existing businesses. Use "Create new business" to modify details.</em></small>
            </div>
        </div>

        <!-- Business Name Search -->
        <div id="search_business_section" style="display: none; margin-bottom: 20px;">
            <label for="search_business_name" style="display: block; margin-bottom: 5px; font-weight: bold;">Business Name:</label>
            <input type="text" id="search_business_name" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <small style="color: #666; display: block; margin-top: 5px;">Enter the exact name of an existing business</small>

            <!-- Warning about modification -->
            <div style="margin-top: 10px; padding: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                <strong>Note:</strong> If the business name matches an existing business, you will be associated with that business. Existing business details cannot be modified.
            </div>
        </div>

        <!-- New Business Section -->
        <div id="new_business_section" style="display: none;">
            <div style="margin-bottom: 15px; padding: 10px; background-color: #e8f4f8; border: 1px solid #bee5eb; border-radius: 4px;">
                <strong>Note:</strong> Creating a new business will remove your current business association
                {% if contact.business %}({{ contact.business.business_name }}){% endif %} and create a new business with the information below.
            </div>

            <div style="margin-bottom: 15px;">
                <label for="business_name" style="display: block; margin-bottom: 5px; font-weight: bold;">Business Name *</label>
                <input type="text" id="business_name" name="business_name" value="" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label for="our_reference_code" style="display: block; margin-bottom: 5px; font-weight: bold;">Reference Code</label>
                <input type="text" id="our_reference_code" name="our_reference_code" value="" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label for="business_number" style="display: block; margin-bottom: 5px; font-weight: bold;">Business Number</label>
                <input type="text" id="business_number" name="business_number" value="" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label for="business_address" style="display: block; margin-bottom: 5px; font-weight: bold;">Business Address</label>
                <textarea id="business_address" name="business_address" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-height: 80px;"></textarea>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="tax_exemption_number" style="display: block; margin-bottom: 5px; font-weight: bold;">Tax Exemption Number</label>
                <input type="text" id="tax_exemption_number" name="tax_exemption_number" value="" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label for="tax_cloud" style="display: block; margin-bottom: 5px; font-weight: bold;">Tax Cloud</label>
                <input type="text" id="tax_cloud" name="tax_cloud" value="" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
        </div>
    </fieldset>

    <button type="submit" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Update Contact</button>
    <a href="{% url 'contacts:contact_detail' contact.contact_id %}" style="background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">Cancel</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all form inputs
    const inputs = document.querySelectorAll('input, textarea');

    // Add event listeners for paste events
    inputs.forEach(function(input) {
        input.addEventListener('paste', function(e) {
            // Small delay to ensure pasted content is processed
            setTimeout(function() {
                // Trigger change and input events to ensure validation
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            }, 10);
        });

        // Also handle input events for any dynamic validation
        input.addEventListener('input', function() {
            // Trigger validation check
            if (input.checkValidity) {
                input.checkValidity();
            }
        });
    });

    // Business selection mode handling
    const businessRadios = document.querySelectorAll('input[name="business_selection_mode"]');
    const existingBusinessSection = document.getElementById('existing_business_section');
    const searchBusinessSection = document.getElementById('search_business_section');
    const newBusinessSection = document.getElementById('new_business_section');
    const searchBusinessInput = document.getElementById('search_business_name');
    const businessNameInput = document.getElementById('business_name');
    const existingBusinessSelect = document.getElementById('existing_business_id');
    const selectedBusinessInfo = document.getElementById('selected_business_info');
    const businessInfoContent = document.getElementById('business_info_content');

    function toggleBusinessSections() {
        const selectedMode = document.querySelector('input[name="business_selection_mode"]:checked')?.value;

        // Hide all sections first
        existingBusinessSection.style.display = 'none';
        searchBusinessSection.style.display = 'none';
        newBusinessSection.style.display = 'none';
        selectedBusinessInfo.style.display = 'none';

        // Show relevant section based on selection
        if (selectedMode === 'existing') {
            existingBusinessSection.style.display = 'block';
            updateSelectedBusinessInfo();
        } else if (selectedMode === 'name_search') {
            searchBusinessSection.style.display = 'block';
        } else if (selectedMode === 'new') {
            newBusinessSection.style.display = 'block';
            clearBusinessFields(); // Clear fields for new business creation
        }
    }

    function updateSelectedBusinessInfo() {
        const selectedOption = existingBusinessSelect.options[existingBusinessSelect.selectedIndex];

        if (selectedOption && selectedOption.value) {
            const businessName = selectedOption.dataset.businessName || 'N/A';
            const referenceCode = selectedOption.dataset.referenceCode || 'Not provided';
            const businessNumber = selectedOption.dataset.businessNumber || 'Not provided';
            const businessAddress = selectedOption.dataset.businessAddress || 'Not provided';
            const taxExemption = selectedOption.dataset.taxExemption || 'Not provided';
            const taxCloud = selectedOption.dataset.taxCloud || 'Not provided';

            businessInfoContent.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    <div><strong>Business Name:</strong> ${businessName}</div>
                    <div><strong>Reference Code:</strong> ${referenceCode}</div>
                    <div><strong>Business Number:</strong> ${businessNumber}</div>
                    <div><strong>Address:</strong> ${businessAddress}</div>
                    <div><strong>Tax Exemption Number:</strong> ${taxExemption}</div>
                    <div><strong>Tax Cloud:</strong> ${taxCloud}</div>
                </div>
            `;
            selectedBusinessInfo.style.display = 'block';
        } else {
            selectedBusinessInfo.style.display = 'none';
        }
    }

    function clearBusinessFields() {
        // Clear all business form fields for new business creation
        businessNameInput.value = '';
        document.getElementById('our_reference_code').value = '';
        document.getElementById('business_number').value = '';
        document.getElementById('business_address').value = '';
        document.getElementById('tax_exemption_number').value = '';
        document.getElementById('tax_cloud').value = '';
    }

    // Add event listeners to radio buttons
    businessRadios.forEach(radio => {
        radio.addEventListener('change', toggleBusinessSections);
    });

    // Add event listener to existing business dropdown
    existingBusinessSelect.addEventListener('change', updateSelectedBusinessInfo);

    // Copy search input to hidden business name field
    searchBusinessInput.addEventListener('input', function() {
        businessNameInput.value = this.value;
    });

    // Initialize sections based on current selection
    toggleBusinessSections();
});
</script>
{% endblock %}