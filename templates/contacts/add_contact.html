{% extends 'base.html' %}

{% block title %}Add Contact - Minibini{% endblock %}

{% block content %}
<h2>Add Contact</h2>

<form method="post">
    {% csrf_token %}
    <p>
        <label for="name"><strong>Name *</strong></label><br>
        <input type="text" id="name" name="name" value="{{ initial_name }}" required>
    </p>

    <p>
        <label for="email"><strong>Email Address</strong></label><br>
        <input type="email" id="email" name="email" value="{{ initial_email }}">
    </p>

    <p>
        <label for="work_number"><strong>Work Phone</strong></label><br>
        <input type="tel" id="work_number" name="work_number">
    </p>

    <p>
        <label for="mobile_number"><strong>Mobile Phone</strong></label><br>
        <input type="tel" id="mobile_number" name="mobile_number">
    </p>

    <p>
        <label for="home_number"><strong>Home Phone</strong></label><br>
        <input type="tel" id="home_number" name="home_number">
    </p>

    <p>
        <label for="address"><strong>Street Address</strong></label><br>
        <input type="text" id="address" name="address">
    </p>

    <p>
        <label for="city"><strong>City</strong></label><br>
        <input type="text" id="city" name="city">
    </p>

    <p>
        <label for="postal_code"><strong>Postal Code</strong></label><br>
        <input type="text" id="postal_code" name="postal_code">
    </p>

    <fieldset>
        <legend><strong>Business Association (Optional)</strong></legend>

        {% if initial_business_name %}
        <p><em>Company detected from email: "{{ initial_business_name }}"</em></p>
        {% endif %}

        <p>
            <label for="business_id"><strong>Select Existing Business</strong></label><br>
            <select id="business_id" name="business_id">
                <option value="NONE" {% if not suggested_business_id %}selected{% endif %}>-- None --</option>
                {% for business in all_businesses %}
                    <option value="{{ business.business_id }}" {% if business.business_id == suggested_business_id %}selected{% endif %}>
                        {{ business.business_name }}
                    </option>
                {% endfor %}
            </select>
            {% if suggested_business_id %}
            <br><small>A matching business was found and pre-selected. Choose "-- None --" if you want to create a new business instead.</small>
            {% elif initial_business_name %}
            <br><small>No matching business found. Select an existing business or choose "-- None --" to create a new one.</small>
            {% endif %}
        </p>
    </fieldset>

    <p>
        <button type="submit">Add Contact</button>
        <a href="{% url 'contacts:contact_list' %}">Cancel</a>
    </p>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all form inputs
    const inputs = document.querySelectorAll('input, textarea');

    // Add event listeners for paste events
    inputs.forEach(function(input) {
        input.addEventListener('paste', function(e) {
            // Small delay to ensure pasted content is processed
            setTimeout(function() {
                // Trigger change and input events to ensure validation
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            }, 10);
        });

        // Also handle input events for any dynamic validation
        input.addEventListener('input', function() {
            // Trigger validation check
            if (input.checkValidity) {
                input.checkValidity();
            }
        });
    });
});
</script>
{% endblock %}